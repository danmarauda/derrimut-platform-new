# CRUSH Cheat Sheet

## Overview
- **Stack**: Next.js 16 (App Router, React 19), TypeScript, TailwindCSS v4, shadcn/ui, Convex backend, Clerk authentication, Stripe payments, Vapi voice AI, Chatbase chatbot, Sentry error tracking.
- **Top-level flow**: `src/app/layout.tsx` composes Convex+Clerk providers, theme provider, global layout, and hydration guards; route modules live under `src/app/**`; Convex functions back the data layer in `convex/`.
- **External services**: Clerk (auth), Stripe (checkout + webhooks), Convex (data + serverless functions), Google Gemini (plan generation), Vapi (voice workflow), Chatbase (support widget), Sentry (error monitoring).

## Project Setup & Commands
- Install dependencies: `npm install`
- Run dev server with Turbopack: `npm run dev`
- Production build & serve: `npm run build` then `npm run start`
- Linting (Next/ESLint flat config): `npm run lint`
- **Testing (Vitest)**: `npm run test`, `npm run test:watch`, `npm run test:coverage`, `npm run test:ui`
- Convex local backend (required for data access): `npx convex dev`
- **Stripe utilities**: `npm run stripe:create-products`, `npm run stripe:update-ids`, `npm run stripe:setup`, `npm run stripe:test`
- **Convex utilities**: `npm run convex:set-env`, `npm run convex:set-env-all`
- **Vercel deployment**: `npm run vercel:deploy`, `npm run vercel:deploy-full`
- **Vapi voice AI**: `npm run vapi:setup`, `npm run vapi:setup-auto`, `npm run vapi:update-voice`
- Image optimization: `npm run optimize-images`
- Bundle analysis: `npm run analyze`
- Lighthouse performance: `npm run lighthouse`

## Environment Configuration
Pulled from `README.md:261-290` and `CHATBASE_SETUP.md`:
- **Convex**: `CONVEX_DEPLOYMENT`, `NEXT_PUBLIC_CONVEX_URL`
- **Clerk**: `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`, `CLERK_SECRET_KEY`, `NEXT_PUBLIC_CLERK_SIGN_IN_URL`, `NEXT_PUBLIC_CLERK_SIGN_UP_URL`
- **Stripe**: `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`, `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`
- **Google Gemini**: `GEMINI_API_KEY`
- **Vapi**: `NEXT_PUBLIC_VAPI_API_KEY`, `NEXT_PUBLIC_VAPI_WORKFLOW_ID`
- **Chatbase**: `NEXT_PUBLIC_CHATBASE_CHAT_ID`, `CHATBASE_SECRET`
- **Sentry**: `SENTRY_ORG`, `SENTRY_PROJECT`, `SENTRY_AUTH_TOKEN`, `NEXT_PUBLIC_SENTRY_DSN`
- Add service-specific secrets before running related flows; most components assume these are defined (check for `process.env.*` guards before calling).

## Directory Structure Highlights
- `src/app/`: Next.js App Router pages, API routes, and feature areas (admin, marketplace, trainer flows, etc.); `globals.css` and `layout.tsx` sit here.
- `src/components/`: Shared React components (navigation, layouts, widgets). shadcn/ui primitives live in `src/components/ui/`.
- `src/providers/`: Context wrappers such as `ConvexClerkProvider.tsx` (Clerk ↔ Convex bridge) and `ThemeProvider.tsx`.
- `src/lib/`: Utilities (`utils.ts` exports `cn`), membership helpers, hydration utilities, environment validation.
- `src/constants/`: Brand constants, data bundles (Derrimut 24:7 Gym branding).
- `src/types/`: TypeScript definitions for fitness, membership, organization, salary, and Stripe types.
- `convex/`: Convex schema (`schema.ts`) plus domain-specific query/mutation/action files (bookings, memberships, marketplace, payroll, etc.). Autogenerated client bindings under `convex/_generated/`.
- `scripts/`: Comprehensive CLI utilities for Stripe setup, Vercel deployment, Vapi configuration, seeding data.
- `public/`: Static assets (logos, hero imagery, optimized images).
- Config files: `next.config.ts`, `eslint.config.mjs`, `postcss.config.mjs`, `tsconfig.json`, `vitest.config.ts`, `components.json` (shadcn alias map).

## Frontend Patterns
- **Global layout**: `src/app/layout.tsx:95-123` wraps children with `ConvexClerkProvider`, `ThemeProvider`, Navbar, Footer, Chatbase widget, and injects a hydration warning suppressor script.
- **Hydration guard**: `BrowserExtensionHandler` in `layout.tsx` overrides `console.error` and strips extension attributes to silence third-party DOM injections.
- **Theme handling**: `src/providers/ThemeProvider.tsx` wraps `next-themes` provider with `attribute="class"` and two themes.
- **Auth-aware UI**: Components (e.g., `src/components/Navbar.tsx`) rely on `useUser()` and `useQuery(api.users.getCurrentUserRole)` to gate links and actions.
- **Data fetching**: Client components call Convex via `useQuery`/`useMutation` from `convex/react` with generated API bindings (`convex/_generated/api`).
- **Styling**: Tailwind classes + `cn` helper (`src/lib/utils.ts`) for conditional class merging; shadcn/ui components follow standard compound patterns.
- **Hydration suppression**: Many JSX nodes include `suppressHydrationWarning` to avoid mismatch errors due to dynamic styling and third-party scripts.
- **Error boundaries**: `src/components/ErrorBoundary.tsx` wraps components for error handling and Sentry integration.
- **Environment validation**: `src/lib/env.ts` validates required environment variables on startup.

## Backend (Convex)
- **Schema**: `convex/schema.ts` defines tables for users, memberships, bookings, marketplace items, blog content, payroll, etc., with extensive indexing (e.g., `bookings` indexes by trainer, status, session date; `membershipPlans` indexes by type/active). Review indexes before writing queries to leverage existing paths.
- **Bookings flow**: `convex/bookings.ts` exposes mutations like `createBooking` (membership-gated, auto-confirmed) and `createPaidBooking` (Stripe webhook path) with explicit argument validation using `v.*` validators and helper utilities for time math.
- **Patterns**: Mutations typically validate membership/role, fetch supporting documents (`ctx.db.get`), compute derived values, then insert/update with timestamps (`Date.now()`). Queries often rely on `.withIndex()` filtering to stay performant.
- **Generated client**: Import from `convex/_generated/api` in React for typed endpoints; server actions can use `convex/_generated/server`.
- **Testing patterns**: Convex functions use `createMockConvexContext` from `src/__tests__/utils` for unit testing.

## Auth & Middleware
- **Clerk integration**: `src/providers/ConvexClerkProvider.tsx` wires `ClerkProvider` and `ConvexProviderWithClerk`, relying on `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` and `NEXT_PUBLIC_CONVEX_URL`.
- **Route protection**: `src/proxy.ts` uses `clerkMiddleware` (Next.js 16 compatible) to enforce auth on `/generate-program`, `/profile`, `/admin(.*)`, `/trainer(.*)`, `/become-trainer`, plus all API routes.
- **Role checks**: UI layers fetch role via `api.users.getCurrentUserRole` (Convex query) to conditionally expose admin/trainer controls.
- **Proxy pattern**: Uses Next.js 16 proxy.ts instead of traditional middleware.ts for better performance and type safety.

## Payments & Webhooks
- **Stripe checkout**: API routes under `src/app/api/**` manage sessions for memberships, marketplace cart, trainer bookings.
- **Webhook handler**: `/api/stripe-webhook/` consumes events—run `stripe listen --forward-to localhost:3000/api/stripe-webhook` during local dev.
- **Debug tooling**: `debug-webhook.js` simulates booking payments against Convex; ensure `NEXT_PUBLIC_CONVEX_URL` and valid Clerk/Convex IDs before running.
- **Price utilities**: `get-price-ids.js` helps retrieve Stripe product pricing for environment configuration.
- **Comprehensive scripts**: `scripts/` directory contains automated Stripe setup, webhook configuration, and testing utilities.

## Testing & QA
- **Framework**: Vitest with React Testing Library, configured in `vitest.config.ts` with jsdom environment.
- **Test locations**: `src/__tests__/`, `convex/__tests__/`, and alongside source files with `.test.ts/.test.tsx` extensions.
- **Commands**: `npm run test` (single run), `npm run test:watch` (watch mode), `npm run test:coverage` (coverage report), `npm run test:ui` (visual interface).
- **Test types**: Unit tests for Convex functions, React component tests, API route tests, auth integration tests.
- **Coverage thresholds**: 30% minimum for branches, functions, lines, statements (configurable in vitest.config.ts).
- **Mock utilities**: `src/__tests__/utils.tsx` provides `createMockConvexContext` and other testing helpers.

## Branding & Business Logic
- **Brand constants**: `src/constants/branding.ts` contains Derrimut 24:7 Gym branding, colors (black/red/yellow), contact details, and membership plans.
- **Membership plans**: Preconfigured Derrimut pricing (18-month minimum $14.95, 12-month minimum $17.95, no lock-in $19.95, 12-month upfront $749).
- **Currency**: AUD with fortnightly payment frequency.
- **Business rules**: Establishment fee $88, casual passes $20 per session.

## Gotchas & Caveats
- `next.config.ts` deliberately ignores TypeScript and ESLint errors during production builds—run `npm run lint`/type checks manually to catch issues early.
- Hydration mismatch suppression relies on overriding `console.error`; remain cautious when debugging genuine hydration problems.
- Many components expect environment variables at build/runtime; missing keys typically cause runtime crashes (use guard rails in `src/lib/env.ts`).
- Convex mutations assume valid document IDs (`v.id("users")`, etc.). Passing raw Clerk IDs where Convex IDs are required will throw.
- Client hydration can be heavy due to multiple `"use client"` components and dynamic gradients—keep new components server-side when possible.
- Dependencies like Clerk, Convex, next-themes, shadcn require matching versions; verify package versions in `package.json` before introducing upgrades.
- Next.js 16 uses proxy.ts instead of middleware.ts for auth middleware.
- Sentry configuration requires proper environment variables for source map uploads and error tracking.

## Additional Resources
- **Project README**: End-to-end feature overview, installation steps, architecture diagrams (`README.md`).
- **Convex README**: Quickstart for writing Convex functions (`convex/README.md`).
- **Chatbase setup**: Environment keys, testing guidance, and customization notes (`CHATBASE_SETUP.md`).
- **Scripts documentation**: Comprehensive CLI tooling guide (`SCRIPTS_README.md`).
- **Config references**: `eslint.config.mjs`, `postcss.config.mjs`, `tsconfig.json`, `vitest.config.ts`, `components.json` for linting, styling, TS, testing, and component aliasing defaults.
- **Sentry configs**: `sentry.client.config.ts`, `sentry.server.config.ts`, `sentry.edge.config.ts` for error monitoring setup.