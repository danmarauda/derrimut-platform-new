# CRUSH Cheat Sheet

## Overview
- **Stack**: Next.js 15 (App Router, React 19), TypeScript, TailwindCSS v4, shadcn/ui, Convex backend, Clerk authentication, Stripe payments, Vapi voice AI, Chatbase chatbot.
- **Top-level flow**: `src/app/layout.tsx` composes Convex+Clerk providers, theme provider, global layout, and hydration guards; route modules live under `src/app/**`; Convex functions back the data layer in `convex/`.
- **External services**: Clerk (auth), Stripe (checkout + webhooks), Convex (data + serverless functions), Google Gemini (plan generation), Vapi (voice workflow), Chatbase (support widget).

## Project Setup & Commands
- Install dependencies: `npm install`
- Run dev server with Turbopack: `npm run dev`
- Production build & serve: `npm run build` then `npm run start`
- Linting (Next/ESLint flat config): `npm run lint`
- Convex local backend (required for data access): `npx convex dev`
- Stripe webhook forwarding (README.md:314): `stripe listen --forward-to localhost:3000/api/webhooks/stripe`
- Stripe price ID helper (root): `node get-price-ids.js`
- Convex webhook simulator (root): `node debug-webhook.js`

## Environment Configuration
Pulled from `README.md:261-290` and `CHATBASE_SETUP.md`:
- **Convex**: `CONVEX_DEPLOYMENT`, `NEXT_PUBLIC_CONVEX_URL`
- **Clerk**: `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`, `CLERK_SECRET_KEY`, `NEXT_PUBLIC_CLERK_SIGN_IN_URL`, `NEXT_PUBLIC_CLERK_SIGN_UP_URL`
- **Stripe**: `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`, `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`
- **Google Gemini**: `GEMINI_API_KEY`
- **Vapi**: `NEXT_PUBLIC_VAPI_API_KEY`, `NEXT_PUBLIC_VAPI_WORKFLOW_ID`
- **Chatbase**: `NEXT_PUBLIC_CHATBASE_CHAT_ID`, `CHATBASE_SECRET`
- Add service-specific secrets before running related flows; most components assume these are defined (check for `process.env.*` guards before calling).

## Directory Structure Highlights
- `src/app/`: Next.js App Router pages, API routes, and feature areas (admin, marketplace, trainer flows, etc.); `globals.css` and `layout.tsx` sit here.
- `src/components/`: Shared React components (navigation, layouts, widgets). shadcn/ui primitives live in `src/components/ui/`.
- `src/providers/`: Context wrappers such as `ConvexClerkProvider.tsx` (Clerk ↔ Convex bridge) and `ThemeProvider.tsx`.
- `src/lib/`: Utilities (`utils.ts` exports `cn`), membership helpers, hydration utilities.
- `src/constants/`, `src/data/`: Static data bundles (recipes, gym locations, etc.).
- `convex/`: Convex schema (`schema.ts`) plus domain-specific query/mutation/action files (bookings, memberships, marketplace, payroll, etc.). Autogenerated client bindings under `convex/_generated/`.
- `public/`: Static assets (logos, hero imagery).
- Config files: `next.config.ts`, `eslint.config.mjs`, `postcss.config.mjs`, `tsconfig.json`, `components.json` (shadcn alias map).

## Frontend Patterns
- **Global layout**: `src/app/layout.tsx:95-123` wraps children with `ConvexClerkProvider`, `ThemeProvider`, Navbar, Footer, Chatbase widget, and injects a hydration warning suppressor script.
- **Hydration guard**: `BrowserExtensionHandler` in `layout.tsx` overrides `console.error` and strips extension attributes to silence third-party DOM injections.
- **Theme handling**: `src/providers/ThemeProvider.tsx` wraps `next-themes` provider with `attribute="class"` and two themes.
- **Auth-aware UI**: Components (e.g., `src/components/Navbar.tsx`) rely on `useUser()` and `useQuery(api.users.getCurrentUserRole)` to gate links and actions.
- **Data fetching**: Client components call Convex via `useQuery`/`useMutation` from `convex/react` with generated API bindings (`convex/_generated/api`).
- **Styling**: Tailwind classes + `cn` helper (`src/lib/utils.ts`) for conditional class merging; shadcn/ui components follow standard compound patterns.
- **Hydration suppression**: Many JSX nodes include `suppressHydrationWarning` to avoid mismatch errors due to dynamic styling and third-party scripts.

## Backend (Convex)
- **Schema**: `convex/schema.ts` defines tables for users, memberships, bookings, marketplace items, blog content, payroll, etc., with extensive indexing (e.g., `bookings` indexes by trainer, status, session date; `membershipPlans` indexes by type/active). Review indexes before writing queries to leverage existing paths.
- **Bookings flow**: `convex/bookings.ts` exposes mutations like `createBooking` (membership-gated, auto-confirmed) and `createPaidBooking` (Stripe webhook path) with explicit argument validation using `v.*` validators and helper utilities for time math.
- **Patterns**: Mutations typically validate membership/role, fetch supporting documents (`ctx.db.get`), compute derived values, then insert/update with timestamps (`Date.now()`). Queries often rely on `.withIndex()` filtering to stay performant.
- **Generated client**: Import from `convex/_generated/api` in React for typed endpoints; server actions can use `convex/_generated/server`.

## Auth & Middleware
- ** Clerk integration**: `src/providers/ConvexClerkProvider.tsx` wires `ClerkProvider` and `ConvexProviderWithClerk`, relying on `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` and `NEXT_PUBLIC_CONVEX_URL`.
- **Route protection**: `src/middleware.ts` uses `clerkMiddleware` to enforce auth on `/generate-program`, `/profile`, `/admin(.*)`, `/trainer(.*)`, `/become-trainer`, plus all API routes.
- **Role checks**: UI layers fetch role via `api.users.getCurrentUserRole` (Convex query) to conditionally expose admin/trainer controls.

## Payments & Webhooks
- **Stripe checkout**: API routes under `src/app/api/**` (see directory structure) manage sessions for memberships, marketplace cart, trainer bookings.
- **Webhook handler**: `/api/webhooks/stripe` consumes events—run `stripe listen --forward-to localhost:3000/api/webhooks/stripe` during local dev.
- **Debug tooling**: `debug-webhook.js` simulates booking payments against Convex; ensure `NEXT_PUBLIC_CONVEX_URL` and valid Clerk/Convex IDs before running.
- **Price utilities**: `get-price-ids.js` helps retrieve Stripe product pricing for environment configuration.

## Testing & QA
- No automated tests present (no Jest/Playwright config). Rely on manual QA flows per feature (membership purchase, booking, marketplace checkout, AI plan generation).
- `test-recipes.md` currently empty—use as scratchpad for recipe validation steps if needed.
- Minimum automated check available: `npm run lint`. Run after changes touching frontend logic or config.

## Gotchas & Caveats
- `next.config.ts` deliberately ignores TypeScript and ESLint errors during production builds—run `npm run lint`/type checks manually to catch issues early.
- Hydration mismatch suppression relies on overriding `console.error`; remain cautious when debugging genuine hydration problems.
- Many components expect environment variables at build/runtime; missing keys typically cause runtime crashes (no guard rails in most files).
- Convex mutations assume valid document IDs (`v.id("users")`, etc.). Passing raw Clerk IDs where Convex IDs are required will throw.
- Client hydration can be heavy due to multiple `"use client"` components and dynamic gradients—keep new components server-side when possible.
- Dependencies like Clerk, Convex, next-themes, shadcn require matching versions; verify package versions in `package.json` before introducing upgrades.

## Additional Resources
- **Project README**: End-to-end feature overview, installation steps, architecture diagrams (`README.md`).
- **Convex README**: Quickstart for writing Convex functions (`convex/README.md`).
- **Chatbase setup**: Environment keys, testing guidance, and customization notes (`CHATBASE_SETUP.md`).
- **Config references**: `eslint.config.mjs`, `postcss.config.mjs`, `tsconfig.json`, `components.json` for linting, styling, TS, and component aliasing defaults.
