name: Deploy Check - Pre-deployment Verification

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  # Verify environment variables
  env-check:
    name: Environment Variables Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required secrets
        run: |
          echo "Checking required environment variables..."
          
          REQUIRED_SECRETS=(
            "NEXT_PUBLIC_CONVEX_URL"
            "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY"
            "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY"
          )
          
          MISSING_SECRETS=()
          
          for secret in "${REQUIRED_SECRETS[@]}"; do
            if [ -z "${{ secrets[secret] }}" ]; then
              MISSING_SECRETS+=("$secret")
            fi
          done
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "‚ùå Missing required secrets:"
            printf '%s\n' "${MISSING_SECRETS[@]}"
            echo ""
            echo "Please add these secrets in GitHub Settings > Secrets and variables > Actions"
            exit 1
          fi
          
          echo "‚úÖ All required secrets are configured"

  # Check for production-ready code
  production-ready:
    name: Production Readiness Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check for console.log in production code
        run: |
          echo "Checking for console.log statements in production code..."
          CONSOLE_LOGS=$(grep -r "console\.log" src/ --include="*.ts" --include="*.tsx" --exclude-dir=__tests__ || echo "")
          
          if [ -n "$CONSOLE_LOGS" ]; then
            echo "‚ö†Ô∏è Warning: Found console.log statements in production code:"
            echo "$CONSOLE_LOGS"
            echo ""
            echo "Note: These will be removed in production build, but consider using a logger instead."
          else
            echo "‚úÖ No console.log statements found"
          fi

      - name: Check for TODO comments
        run: |
          echo "Checking for critical TODO comments..."
          CRITICAL_TODOS=$(grep -r "TODO.*CRITICAL\|TODO.*URGENT\|TODO.*FIXME" src/ convex/ --include="*.ts" --include="*.tsx" || echo "")
          
          if [ -n "$CRITICAL_TODOS" ]; then
            echo "‚ùå Found critical TODO comments that must be resolved:"
            echo "$CRITICAL_TODOS"
            exit 1
          else
            echo "‚úÖ No critical TODO comments found"
          fi

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential hardcoded secrets..."
          
          # Check for common secret patterns
          SECRETS_FOUND=$(grep -r -E "(api[_-]?key|secret[_-]?key|password|token).*=.*['\"][a-zA-Z0-9]{20,}" src/ --include="*.ts" --include="*.tsx" || echo "")
          
          if [ -n "$SECRETS_FOUND" ]; then
            echo "‚ö†Ô∏è Warning: Potential hardcoded secrets found:"
            echo "$SECRETS_FOUND"
            echo ""
            echo "Please verify these are not actual secrets!"
          else
            echo "‚úÖ No obvious hardcoded secrets found"
          fi

      - name: Verify Stripe product IDs
        run: |
          echo "Checking for placeholder Stripe IDs..."
          PLACEHOLDER_IDS=$(grep -r "price_1SRF1M4ghJnevp5XHk8AwEB0\|prod_TO13HhWD4id9gk" convex/ src/ || echo "")
          
          if [ -n "$PLACEHOLDER_IDS" ]; then
            echo "‚ö†Ô∏è Warning: Found placeholder Stripe IDs:"
            echo "$PLACEHOLDER_IDS"
            echo ""
            echo "These should be replaced with production Stripe IDs before deploying to production."
          else
            echo "‚úÖ No placeholder Stripe IDs found"
          fi

  # Verify build size
  bundle-size:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build and analyze bundle
        run: |
          bun run build
          
          # Check .next directory size
          NEXT_SIZE=$(du -sh .next | cut -f1)
          echo "Build size: $NEXT_SIZE"
          
          # Check for large chunks
          echo ""
          echo "Largest JavaScript chunks:"
          find .next/static/chunks -name "*.js" -type f -exec du -h {} + | sort -rh | head -10

      - name: Check bundle size limits
        run: |
          # Get total size in MB
          TOTAL_SIZE=$(du -sm .next | cut -f1)
          
          if [ "$TOTAL_SIZE" -gt 100 ]; then
            echo "‚ö†Ô∏è Warning: Build size is ${TOTAL_SIZE}MB (limit: 100MB)"
            echo "Consider optimizing bundle size"
          else
            echo "‚úÖ Build size is acceptable: ${TOTAL_SIZE}MB"
          fi

  # Database migration check
  convex-check:
    name: Convex Schema Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Verify Convex schema
        run: |
          echo "Checking Convex schema for issues..."
          
          # Check if schema file exists
          if [ ! -f "convex/schema.ts" ]; then
            echo "‚ùå convex/schema.ts not found"
            exit 1
          fi
          
          # Check for common schema issues
          if grep -q "any" convex/schema.ts; then
            echo "‚ö†Ô∏è Warning: Found 'any' type in schema"
          fi
          
          echo "‚úÖ Convex schema file exists"

  # Final deployment readiness
  deploy-ready:
    name: Deployment Ready ‚úÖ
    runs-on: ubuntu-latest
    needs: [env-check, production-ready, bundle-size, convex-check]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.env-check.result }}" != "success" ] || \
             [ "${{ needs.production-ready.result }}" != "success" ] || \
             [ "${{ needs.bundle-size.result }}" != "success" ] || \
             [ "${{ needs.convex-check.result }}" != "success" ]; then
            echo "‚ùå Some deployment checks failed"
            exit 1
          fi
          echo "‚úÖ All deployment checks passed! Ready to deploy."

      - name: Post deployment readiness comment
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ **Deployment Ready!** All pre-deployment checks passed. This PR is ready to be merged and deployed.'
            })

